# P2P网络部分
根据笔者对区块链的研究，其实是一个建立在P2P网络上的分布式数据库，节点为了达成数据上的一致会设计一个协议帮助网络达成共识  
这节介绍的是节点连接到网络的过程  
## 节点发现
当一个新节点加入网络后，需要与网络中其他节点发生连接。比特币的网络拓扑结构不基于地理位置，因此可以随机选择节点进行连接  
1、利用种子节点  
比特币的客户端会维护一个列表，列表中记录了长期稳定运行的节点，这些节点也被称之为种子节点，连接到种子节点的好处就是新节点可以快速的发现网络中的其他节点。在比特币里，可以通过选项“-dnsseed”来指定是否使用种子节点，该选项默认是开启的。  
2、节点引荐  
将当前启动节点引荐给其他节点。可以通过“-seednode”选项指定一个节点的ip，之后会和该节点建立连接，将该节点作为DNS种子节点，在引荐信息形成之后断开与该节点的连接，并与新发现的节点连接。  

## 握手协议
节点进行握手协议，会发送一个包含基本识别信息的版本消息开始一次“握手”，消息内容包括：  
nVerison：客户端使用比特币P2P协议版本  
nLocalServices：节点支持的本地服务列表，目前是NODE_NETWORK  
nTime：当前时间  
addrYou：当前节点看到的远程节点IP地址


## 源码分析
### 结构体定义一览
1、类CBaseChainParams  
这个类定义了比特币的基本参数，主要是比特币的数据存储目录和相互通信的rpc端口号  
```
class CBaseChainParams
{
public:
    /** BIP70 chain name strings (main, test or regtest) */
    static const std::string MAIN;
    static const std::string TESTNET;
    static const std::string REGTEST;

    const std::string& DataDir() const { return strDataDir; }
    int RPCPort() const { return nRPCPort; }

    CBaseChainParams() = delete;
    CBaseChainParams(const std::string& data_dir, int rpc_port) : nRPCPort(rpc_port), strDataDir(data_dir) {}

private:
    int nRPCPort;
    std::string strDataDir;
};
```
这里有三个字符串，表示比特币的三种网络，分别是主干网、测试网和REGTEST  
之后定义了本地通信端口以及远程的rpc端口，以及数据存储的目录  

2、类CChainParams
这个类有许多成员，需要仔细辨别  
```
Consensus::Params consensus;
CMessageHeader::MessageStartChars pchMessageStart;
int nDefaultPort;
uint64_t nPruneAfterHeight;
std::vector<std::string> vSeeds;
std::vector<unsigned char> base58Prefixes[MAX_BASE58_TYPES];
std::string bech32_hrp;
std::string strNetworkID;
CBlock genesis;
std::vector<SeedSpec6> vFixedSeeds;
bool fDefaultConsistencyChecks;
bool fRequireStandard;
bool fMineBlocksOnDemand;
CCheckpointData checkpointData;
ChainTxData chainTxData;
bool m_fallback_fee_enabled;
```
其中包括了nDefaultPort、vSeeds等  
通过网上查询可知：  
nDefaultPort代表默认端口，是8333  
vSeeds代表比特币内置的一些种子节点，即新节点可以通过这些节点连接到网络  

3、类CMainParams  
该类继承于CChainParams，初始化了一些核心的比特币参数  
```
consensus.nPowTargetTimespan = 14 * 24 * 60 * 60; // two weeks
nDefaultPort = 8333;

vSeeds.emplace_back("seed.bitcoin.sipa.be"); // Pieter Wuille, only supports x1, x5, x9, and xd
vSeeds.emplace_back("dnsseed.bluematt.me"); // Matt Corallo, only supports x9
vSeeds.emplace_back("dnsseed.bitcoin.dashjr.org"); // Luke Dashjr
vSeeds.emplace_back("seed.bitcoinstats.com"); // Christian Decker, supports x1 - xf
vSeeds.emplace_back("seed.bitcoin.jonasschnelli.ch"); // Jonas Schnelli, only supports x1, x5, x9, and xd
vSeeds.emplace_back("seed.btc.petertodd.org"); // Peter Todd, only supports x1, x5, x9, and xd
vSeeds.emplace_back("seed.bitcoin.sprovoost.nl"); // Sjors Provoost
```
以上是我截出来的一部分代码，可以看出有难度调节的时间、端口号、以及一些默认的种子节点  

4、类CConnman
该类是进行网络管理的，负责节点的初始化以及启动，P2P消息的推送以及接收，比较庞大，此处不再介绍  

5、类NetEventsInterface  
该类的作用是定义了接口，这些函数是纯虚函数   
```
class NetEventsInterface
{
public:
    virtual bool ProcessMessages(CNode* pnode, std::atomic<bool>& interrupt) = 0;
    virtual bool SendMessages(CNode* pnode) = 0;
    virtual void InitializeNode(CNode* pnode) = 0;
    virtual void FinalizeNode(NodeId id, bool& update_connection_time) = 0;

protected:
    /**
     * Protected destructor so that instances can only be deleted by derived classes.
     * If that restriction is no longer desired, this should be made public and virtual.
     */
    ~NetEventsInterface() = default;
};
```
首先是ProcessMessages，出来接收到的消息  
SendMessage，发送消息  
InitializeNode，初始化节点  

6、CNetAddr和CService






入口函数在bitcoind.cpp中，如下所示：  
```
int main(int argc, char* argv[])
{
    SetupEnvironment();

    // Connect bitcoind signal handlers
    noui_connect();

    return (AppInit(argc, argv) ? EXIT_SUCCESS : EXIT_FAILURE);
}
```
首先设置环境函数，其次是


```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```